<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
    <title>IJM</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>

<body>
    <div class="p-4">
        <div class="row">
            <div class="col">
                <h4>Upload File</h4>
            </div>
        </div>
        <form>
            <div class="row">
                <div class="col-sm-12 col-md-6 p-3">
                    <label class="form-label">File Name</label>
                    <input class="form-control" type="text" placeholder="Unique Name" id="filename" required="">
                </div>
                <div class="col-sm-12 col-md-6 p-3">
                    <label class="form-label">Search Tags</label>
                    <input class="form-control" type="text" required="" placeholder="tag separated by comma(,)" id="tags">
                </div>
            </div>
            <div class="row">
                <div class="col-sm-12 col-md-6 p-3">
                    <label class="form-label">Category</label>
                    <select id="mySelect" class="form-select" onchange="function2(this.value)" required>
                        <option value="">Select</option>
                    </select>
                </div>
                <div class="col-sm-12 col-md-6 p-3">
                    <label class="form-label">Sub Category</label>
                    <select id="mySelect2" class="form-select" required>
                        <option value="">Select</option>
                    </select>
                </div>
            </div>
            <div class="row">
                <div class="col-sm-12 col-md-6 p-3">
                    <label class="form-label">Public Visibility</label>
                    <select class="form-select" id="mySelect3">
                        <option value="public" selected="">Public</option>
                        <option value="private">Private</option>
                    </select>
                </div>
                <div class="col-sm-12 col-md-6 p-3">
                    <label class="form-label">Select File</label>
                    <input class="form-control" type="file" id="fileUpload" required>
                </div>
            </div>
            <div class="row">
                <div class="col-12 text-center p-3">
                    <button class="btn btn-primary" type="submit">Upload Now</button>
                </div>
            </div>
        </form>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script>
        var myHeaders = new Headers();
        myHeaders.append("file", "");
        myHeaders.append("Content-Type", "application/json");

        var raw = JSON.stringify({
            "trigger_word": "category",
            "data": "none"
        });

        fetch("https://dgy9ffjm0xcw9.cloudfront.net/category", {
            method: 'POST',
            body: raw,
        })
        .then(response => response.text())
        .then(function(result){
            result = JSON.parse(result);
            for (let i = 0; i < result["data"].length; i++) {
                const element = result["data"][i];
                var x = document.getElementById("mySelect");
                var option = document.createElement("option");
                option.text = element;
                option.setAttribute("value",element);
                x.add(option);
            }
        })
        .catch(error => console.log('error', error));

        function function2(val){
            var select = document.getElementById("mySelect2");
            var length = select.options.length;
            for (i = length-1; i >= 0; i--) {
                select.options[i] = null;
            }
            // console.log(val);
        var myHeaders = new Headers();
        myHeaders.append("file", "");
        myHeaders.append("Content-Type", "application/json");

        var raw = JSON.stringify({
        "trigger_word": "sub_category",
        "data": val
        });

        fetch("https://dgy9ffjm0xcw9.cloudfront.net/category", {
            method: 'POST',
            body: raw,
        })
        .then(response => response.text())
        .then(function(result){
            result = JSON.parse(result);
            for (let i = 0; i < result["data"].length; i++) {
                const element = result["data"][i];
                var x = document.getElementById("mySelect2");
                var option = document.createElement("option");
                option.text = element;
                option.setAttribute("value",element);
                x.add(option);
            }
        })
        }

        var uploadField = document.getElementById("fileUpload");

        uploadField.onchange = function() {
            if(this.files[0].size > 209715200){
            alert("File is too big!");
            this.value = "";
            };
        };

        function filename_check(name) {
            var data = JSON.stringify({
            "file_name": name
            });

            var config = {
            method: 'post',
            url: 'https://dgy9ffjm0xcw9.cloudfront.net/file_name_check',
            headers: { 
                'Content-Type': 'application/json'
            },
            data : data
            };

            axios(config)
            .then(function (response) {
            console.log(JSON.stringify(response.data));
            })
            .catch(function (error) {
            console.log(error);
            });
//             var myHeaders = new Headers();
//             myHeaders.append("Content-Type", "application/json");
//             myHeaders.append('Access-Control-Allow-Origin','*');            
//             myHeaders.append("Access-Control-Allow-Methods", "*");

//             var raw = JSON.stringify({
//                 "file_name": name
//             });

//             var requestOptions = {
//                 method: 'POST',
//                 headers: myHeaders,
//                 body: raw,
//                 redirect: 'manual'
//             };

//             fetch("https://dgy9ffjm0xcw9.cloudfront.net/file_name_check", requestOptions)
//             .then(response => response.text())
//             .then(
//                 function(result){
//                     var nandan = JSON.parse(result);
//                     console.log(nandan.message);
//                 })
//             .catch(error => console.log('error', error));
        }

        $(document).ready(function() {
            $('form').on('submit', function(event) {
                event.preventDefault();
                var newFilename = document.getElementById("filename").value;
                var tags = document.getElementById("tags").value;
                var category = document.getElementById("mySelect").value;
                var sub_category = document.getElementById("mySelect2").value;
                var public_visibility = document.getElementById("mySelect3").value;
                var myInput = document.getElementById('fileUpload');
                var filename = myInput.files[0].name;
                var extension = filename.split('.').pop();
                newFilename = String(newFilename+'.'+extension);
                filename_check(newFilename);
            })
        });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>
